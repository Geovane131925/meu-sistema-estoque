<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Sistema Semi J√≥ias ‚Äî Multiusu√°rio (Admin + Vendedores)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <style>
    body{background:#f5f7fb;font-family:Inter,Arial,Helvetica,sans-serif}
    .container{max-width:1100px;margin-top:20px}
    .card{border-radius:10px}
    .small-input{height:38px;padding:6px}
    .muted{color:#6b7280}
    .badge-low{background:#fff3cd;color:#a35b00;padding:4px 8px;border-radius:8px}
    .badge-empty{background:#f8d7da;color:#842029;padding:4px 8px;border-radius:8px}
    #loginBox{max-width:420px;margin:80px auto}
    .hidden{display:none}
  </style>
</head>
<body>
  
  <div class="container" id="app" style="display:none">    <h2 class="mb-3 text-center">üíé Sistema de Estoque ‚Äî Semi J√≥ias</h2>
    <div class="d-flex justify-content-between align-items-center mb-2">      <div>        Logado como: <strong id="currentUserLabel"></strong> <span id="roleLabel" class="muted"></span>      </div>      <div>        <button class="btn btn-outline-secondary btn-sm" id="btnLogout">Sair</button>      </div>    </div>
    <ul class="nav nav-tabs mb-3" id="mainTabs" role="tablist">      <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#estoqueTab">Estoque</button></li>      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#vendasTab">Vendas</button></li>      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#despesasTab">Despesas</button></li>      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#relTab">Relat√≥rios</button></li>      <li class="nav-item" id="liUsers" style="display:none"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#usersTab" disabled>Usu√°rios (API Pendente)</button></li>    </ul>
    <div class="tab-content">
      <div class="tab-pane fade show active" id="estoqueTab">        <div class="card mb-3">          <div class="card-body">            <h5>Cadastrar / Editar Produto</h5>            <form id="formProduto" class="row g-2 align-items-end">              <input type="hidden" id="produtoId"/>              <div class="col-md-4">                <label class="form-label small">Nome</label>                <input id="produtoNome" class="form-control" required/>              </div>              <div class="col-md-2">                <label class="form-label small">C√≥digo</label>                <input id="produtoCodigo" class="form-control"/>              </div>              <div class="col-md-1">                <label class="form-label small">Qtd</label>                <input id="produtoQtd" type="number" min="0" class="form-control small-input" value="1"/>              </div>              <div class="col-md-1">                <label class="form-label small">Min</label>                <input id="produtoMin" type="number" min="0" class="form-control small-input" value="0"/>              </div>              <div class="col-md-2">                <label class="form-label small">Custo</label>                <input id="produtoCusto" type="number" step="0.01" class="form-control small-input" value="0"/>              </div>              <div class="col-md-1">                <label class="form-label small">Pre√ßo</label>                <input id="produtoPreco" type="number" step="0.01" class="form-control small-input" value="0"/>              </div>              <div class="col-md-1">                <label class="form-label small">Exportar?</label><br/>                <input type="checkbox" id="produtoExport" title="Exportar para vendedores">              </div>
              <div class="col-12 text-end mt-1">                <button class="btn btn-success btn-sm" type="submit">Salvar</button>                <button class="btn btn-outline-secondary btn-sm" type="button" id="limparProdutoBtn">Limpar</button>                <button class="btn btn-outline-secondary btn-sm" type="button" onclick="exportCSV('products')">Exportar CSV (produtos marcados)</button>              </div>            </form>          </div>        </div>
        <div class="card">          <div class="card-body">            <div class="d-flex justify-content-between align-items-center mb-2">              <div class="d-flex gap-2">                <input id="searchProduct" class="form-control form-control-sm" placeholder="Buscar por nome ou c√≥digo" style="min-width:280px"/>                <button class="btn btn-sm btn-outline-secondary" onclick="renderProducts()">Buscar</button>              </div>              <div class="muted">Dados salvos no servidor (API)</div>            </div>
            <div style="overflow:auto;max-height:360px">              <table class="table table-sm table-striped">                <thead class="table-light"><tr><th>Nome</th><th>C√≥d</th><th>Qtd</th><th>Min</th><th>Pre√ßo</th><th id="thCusto">Custo</th><th></th></tr></thead>                <tbody id="productsTbody"></tbody>              </table>            </div>          </div>        </div>      </div>
      <div class="tab-pane fade" id="vendasTab">        <div class="card mb-3">          <div class="card-body">            <h5>Registrar Venda</h5>            <form id="formVenda" class="row g-2 align-items-end">              <div class="col-md-4">                <label class="form-label small">Produto</label>                <select id="saleProduct" class="form-select"></select>              </div>              <div class="col-md-2">                <label class="form-label small">Pre√ßo (sugerido ‚Äî edit√°vel)</label>                <input id="salePrice" type="number" step="0.01" class="form-control small-input"/>              </div>              <div class="col-md-1">                <label class="form-label small">Qtd</label>                <input id="saleQty" type="number" min="1" class="form-control small-input" value="1"/>              </div>              <div class="col-md-2">                <label class="form-label small">Vendedor</label>                <input id="saleSeller" class="form-control" disabled/>              </div>              <div class="col-md-1">                <label class="form-label small">Comiss√£o %</label>                <input id="saleCommissionPct" type="number" step="0.1" class="form-control small-input" value="10"/>              </div>              <div class="col-md-1 text-end">                <button class="btn btn-primary btn-sm" type="submit">Registrar</button>              </div>              <div class="col-md-1 text-end">                <button class="btn btn-outline-secondary btn-sm" type="button" onclick="exportCSV('sales')">Exportar CSV</button>              </div>            </form>          </div>        </div>
        <div class="card mb-3">          <div class="card-body">            <h6>Filtros</h6>            <div class="row g-2 align-items-end">              <div class="col-md-3"><label class="form-label small">Data in√≠cio</label><input id="saleFilterStart" type="date" class="form-control"/></div>              <div class="col-md-3"><label class="form-label small">Data fim</label><input id="saleFilterEnd" type="date" class="form-control"/></div>              <div class="col-md-3"><label class="form-label small">Vendedor (ADM pode filtrar)</label><input id="saleFilterSeller" class="form-control" placeholder="Deixar em branco para todos"/></div>              <div class="col-md-3 text-end"><button class="btn btn-secondary btn-sm" onclick="filterSales()">Filtrar</button> <button class="btn btn-outline-secondary btn-sm" onclick="showAllSales()">Mostrar tudo</button></div>            </div>          </div>        </div>
        <div class="card">          <div class="card-body" style="max-height:320px;overflow:auto">            <table class="table table-sm table-striped">              <thead class="table-light"><tr><th>Data</th><th>Produto</th><th>Qtd</th><th>Pre√ßo</th><th>Total</th><th>Vendedor</th><th>Comiss√£o</th></tr></thead>              <tbody id="salesTbody"></tbody>            </table>          </div>        </div>      </div>
      <div class="tab-pane fade" id="despesasTab">        <div class="card mb-3">          <div class="card-body">            <h5>Registrar Despesa</h5>            <form id="formDespesa" class="row g-2 align-items-end">              <div class="col-md-6">                <label class="form-label small">Descri√ß√£o</label>                <input id="expenseDesc" class="form-control"/>              </div>              <div class="col-md-2">                <label class="form-label small">Valor (R$)</label>                <input id="expenseValue" type="number" step="0.01" class="form-control small-input"/>              </div>              <div class="col-md-2">                <label class="form-label small">Data</label>                <input id="expenseDate" type="date" class="form-control"/>              </div>              <div class="col-md-2 text-end">                <button class="btn btn-success btn-sm" type="submit">Adicionar</button>                <button class="btn btn-outline-secondary btn-sm" type="button" onclick="exportCSV('expenses')">Exportar CSV</button>              </div>            </form>          </div>        </div>
        <div class="card mb-3">          <div class="card-body">            <h6>Filtros de Despesas</h6>            <div class="row g-2 align-items-end">              <div class="col-md-4"><label class="form-label small">Data in√≠cio</label><input id="expenseFilterStart" type="date" class="form-control"/></div>              <div class="col-md-4"><label class="form-label small">Data fim</label><input id="expenseFilterEnd" type="date" class="form-control"/></div>              <div class="col-md-4 text-end"><button class="btn btn-secondary btn-sm" onclick="filterExpenses()">Filtrar</button> <button class="btn btn-outline-secondary btn-sm" onclick="showAllExpenses()">Mostrar tudo</button></div>            </div>          </div>        </div>
        <div class="card">          <div class="card-body" style="max-height:320px;overflow:auto">            <table class="table table-sm table-striped">              <thead class="table-light"><tr><th>Data</th><th>Descri√ß√£o</th><th>Valor</th></tr></thead>              <tbody id="expensesTbody"></tbody>            </table>          </div>        </div>      </div>
      <div class="tab-pane fade" id="relTab">        <div class="card mb-3">          <div class="card-body">            <h5>Relat√≥rio R√°pido</h5>            <p><strong>Valor em estoque:</strong> R$ <span id="reportStock">0.00</span></p>            <p><strong>Vendas (total):</strong> R$ <span id="reportSales">0.00</span></p>            <p><strong>Despesas (total):</strong> R$ <span id="reportExpenses">0.00</span></p>            <p><strong>Comiss√µes (total):</strong> R$ <span id="reportCommissions">0.00</span></p>            <hr/>            <p><strong>Lucro l√≠quido:</strong> R$ <span id="reportNet">0.00</span></p>          </div>        </div>
        <div class="card mb-3">          <div class="card-body">            <h5>Backup / Restaurar (Arquivo √önico JSON)</h5>            <p class="muted">Os dados agora s√£o salvos automaticamente no servidor. Esta se√ß√£o de backup/restore foi desativada.</p>            </div>        </div>      </div>
      <div class="tab-pane fade" id="usersTab">        <div class="card mb-3">          <div class="card-body">            <h5>Gerenciar Usu√°rios</h5>            <p class="text-danger"><b>Funcionalidade desativada.</b></p>            <p class="muted">Sua API (back-end) ainda n√£o possui as rotas necess√°rias para Listar, Criar ou Deletar usu√°rios (ex: /api/users). Apenas o /api/login est√° dispon√≠vel.            </p>            </div>        </div>      </div>
    </div> </div> <div id="loginBox" class="card">
    <div class="card-body">
      <h4 class="card-title text-center">Acesse o Sistema</h4>
      <form id="loginForm">
        <div class="mb-2"><label class="form-label small">Usu√°rio</label><input id="loginUser" class="form-control" required value="admin"></div>
        <div class="mb-2"><label class="form-label small">Senha</label><input id="loginPass" type="password" class="form-control" required value="admin123"></div>
        <div class="d-grid gap-2">
          <button class="btn btn-primary" type="submit">Entrar</button>
          <button class="btn btn-link" type="button" id="btnForgot" disabled>Esqueci a senha</button>
        </div>
      </form>
      <div id="loginMessage" class="text-danger mt-2"></div>      <small class="muted">Conta admin inicial: <strong>admin</strong> / senha inicial: <strong>admin123</strong>.</small>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  /* ===========================
      CONFIGURA√á√ÉO DA API
     =========================== */
  
  // üõë URL ATUALIZADA üõë
  const API_URL = "https://silacessorios.pythonanywhere.com";

  /* ===========================
      ESTADO GLOBAL (EM MEM√ìRIA)
     =========================== */
  // N√£o usamos mais localStorage. Os dados v√™m da API e ficam em mem√≥ria.
  let products = []
  let sales = []
  let expenses = []
  // A lista de usu√°rios n√£o √© mais gerenciada pelo front-end
  
  let currentUser = null // { username, role }

  /* ===========================
     HELPERS (Seus helpers originais)
     =========================== */
  function todayISO(){ return new Date().toISOString().split('T')[0] }
  function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,6) }
  function money(v){ return Number(v||0).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2}) }
  
  // Fun√ß√µes de load/save do localStorage foram REMOVIDAS.

  /* ===========================
     INICIALIZA√á√ÉO
     =========================== */
  // Mostra o login box ao carregar
  document.getElementById('loginBox').style.display = 'block'
  

  /* ===========================
     FLUXO DE LOGIN (MODIFICADO)
     =========================== */
  document.getElementById('loginForm').addEventListener('submit', async e => {
    e.preventDefault()
    const user = document.getElementById('loginUser').value.trim()
    const pass = document.getElementById('loginPass').value
    const msgEl = document.getElementById('loginMessage')
    msgEl.textContent = 'Autenticando...'

    if(!user || !pass) {
      msgEl.textContent = 'Preencha usu√°rio e senha';
      return;
    }

    try {
        // 1. CHAMA A API DE LOGIN
        const response = await fetch(`${API_URL}/api/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username: user, password: pass })
        });

        const data = await response.json();

        if (!response.ok) { // Ex: 401 Credenciais inv√°lidas
            throw new Error(data.message || 'Erro de autentica√ß√£o');
        }

        // 2. SUCESSO NO LOGIN
        msgEl.textContent = '';
        currentUser = { username: user, role: data.role }
        await initAfterLogin(); // Chama a inicializa√ß√£o da aplica√ß√£o

    } catch (error) {
        console.error('Falha no login:', error);
        msgEl.textContent = `Erro: ${error.message}`;
    }
  })

  document.getElementById('btnLogout').addEventListener('click', ()=>{
    if(!confirm('Deseja sair?')) return
    currentUser = null
    // Reseta o estado
    products = []
    sales = []
    expenses = []
    // Mostra o login
    document.getElementById('app').style.display = 'none'
    document.getElementById('loginBox').style.display = 'block'
    document.getElementById('loginForm').reset()
    document.getElementById('loginMessage').textContent = ''
  })

  /* ===========================
     SINCRONIZA√á√ÉO COM API (NOVO)
     =========================== */

  /**
   * Carrega TODOS os dados (products, sales, expenses) da API
   * e armazena nas vari√°veis globais.
   */
  async function loadAllDataFromServer() {
      console.log('Buscando dados do servidor...');
      try {
          const [productsRes, salesRes, expensesRes] = await Promise.all([
              fetch(`${API_URL}/api/products`),
              fetch(`${API_URL}/api/sales`),
              fetch(`${API_URL}/api/expenses`)
          ]);

          if (!productsRes.ok || !salesRes.ok || !expensesRes.ok) {
              throw new Error('Falha ao buscar dados da API');
          }

          // Atualiza as vari√°veis globais
          products = await productsRes.json();
          sales = await salesRes.json();
          expenses = await expensesRes.json();
          
          console.log('Dados carregados:', { products, sales, expenses });

      } catch (error) {
          console.error('Erro carregando dados:', error);
          alert('ERRO FATAL: N√£o foi poss√≠vel carregar os dados do servidor. Verifique sua conex√£o ou a URL da API.');
      }
  }

  /**
   * Salva TODOS os dados (products, sales, expenses) de volta na API
   * usando a rota /api/import.
   */
  async function saveDatabase() {
      console.log('Salvando dados no servidor...');
      // AVISO: Apenas Admins podem salvar (vamos checar no back-end, mas √© bom travar aqui)
      if (currentUser.role !== 'admin') {
          console.warn('Vendedores n√£o podem salvar produtos/despesas (apenas vendas, o que √© um ajuste a ser feito)');
          // Por enquanto, a API /api/import substitui TUDO.
          // Se um vendedor adicionar uma VENDA, precisamos enviar TUDO.
      }

      // A sua API /api/import espera o banco de dados completo
      const payload = {
          products: products,
          sales: sales,
          expenses: expenses
          // A API n√£o gerencia 'users', ent√£o n√£o enviamos
      };

      try {
          const response = await fetch(`${API_URL}/api/import`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
          });

          if (!response.ok) {
              throw new Error('Falha ao salvar dados no servidor');
          }
          
          console.log('Dados salvos com sucesso!');
          // Opcional: recarregar os dados para garantir consist√™ncia
          // await loadAllDataFromServer();
          
      } catch (error) {
          console.error('Erro ao salvar dados:', error);
          alert('ERRO: N√£o foi poss√≠vel salvar as altera√ß√µes no servidor.');
      }
  }


  /* ===========================
     AP√ìS LOGIN - RENDERIZAR INTERFACE
     =========================== */
  async function initAfterLogin(){
    document.getElementById('loginBox').style.display = 'none'
    document.getElementById('app').style.display = 'block'
    document.getElementById('currentUserLabel').innerText = currentUser.username
    document.getElementById('roleLabel').innerText = '(' + currentUser.role + ')'
    
    // Elementos de Admin (Oculta Custo para Vendedor)
    if(currentUser.role === 'admin'){
      // document.getElementById('liUsers').style.display = 'block' // Desativado
      document.getElementById('thCusto').style.display = ''
    } else {
      // document.getElementById('liUsers').style.display = 'none' // Desativado
      document.getElementById('thCusto').style.display = 'none'
      
      // Vendedores n√£o podem mexer em despesas ou produtos
      document.getElementById('formProduto').querySelectorAll('input, button').forEach(el => el.disabled = true);
      document.getElementById('formDespesa').querySelectorAll('input, button').forEach(el => el.disabled = true);
    }
    
    // Define o campo vendedor
    document.getElementById('saleSeller').value = currentUser.username
    
    // CARREGA OS DADOS DA API
    await loadAllDataFromServer();
    
    // RENDERIZA TUDO com os dados carregados
    renderProducts(); 
    renderProductOptions(); 
    renderSales(); 
    renderExpenses(); 
    // renderUsers(); // Desativado
    computeReport();
  }

  /* ===========================
     PRODUTOS (MODIFICADO)
     =========================== */
  document.getElementById('formProduto').addEventListener('submit', async e => {
    e.preventDefault()
    if(currentUser.role !== 'admin') return alert('Apenas admin pode criar/editar produtos')
    
    const id = document.getElementById('produtoId').value
    const name = document.getElementById('produtoNome').value.trim()
    const code = document.getElementById('produtoCodigo').value.trim()
    const qty = Number(document.getElementById('produtoQtd').value||0)
    const minQty = Number(document.getElementById('produtoMin').value||0)
    const cost = Number(document.getElementById('produtoCusto').value||0)
    const price = Number(document.getElementById('produtoPreco').value||0)
    const exportFlag = document.getElementById('produtoExport').checked
    
    if(!name) return alert('Nome obrigat√≥rio')
    
    if(id){
      // Editar produto existente no array
      const p = products.find(x=>x.id===id)
      Object.assign(p,{name,code,qty,minQty,cost,price,exportFlag})
    } else {
      // Adicionar novo produto ao array
      products.push({ id: uid(), name, code, qty, minQty, cost, price, exportFlag })
    }
    
    // SALVA O BANCO DE DADOS INTEIRO NA API
    await saveDatabase(); 
    
    clearProductForm(); 
    renderProducts(); 
    renderProductOptions(); 
    computeReport();
  })
  
  // Limpar formul√°rio (l√≥gica local, mantida)
  document.getElementById('limparProdutoBtn').addEventListener('click', clearProductForm)
  function clearProductForm(){
    document.getElementById('produtoId').value=''
    document.getElementById('produtoNome').value=''
    document.getElementById('produtoCodigo').value=''
    document.getElementById('produtoQtd').value=1
    document.getElementById('produtoMin').value=0
    document.getElementById('produtoCusto').value=0
    document.getElementById('produtoPreco').value=0
    document.getElementById('produtoExport').checked=false
  }

  // Renderizar (l√≥gica local, mantida)
  // Esta fun√ß√£o agora l√™ da vari√°vel global 'products'
  function renderProducts(){
    const tbody = document.getElementById('productsTbody'); tbody.innerHTML=''
    const q = (document.getElementById('searchProduct').value||'').toLowerCase().trim()
    
    products.filter(p=> (p.name + (p.code||'')).toLowerCase().includes(q)).forEach(p=>{
      const low = Number(p.qty) <= Number(p.minQty||0)
      const tr = document.createElement('tr')
      tr.innerHTML = `<td>${p.name}</td><td>${p.code||''}</td><td>${p.qty}</td><td>${p.minQty||0}</td><td>R$ ${money(p.price)}</td>
        <td ${currentUser.role==='admin' ? '' : 'style="display:none"'}>R$ ${money(p.cost)}</td>
        <td class="text-end">
          ${low ? (p.qty==0 ? '<span class="badge-empty">ESGOTADO</span>' : '<span class="badge-low">BAIXO</span>') : ''}
          ${currentUser.role==='admin' ? `<button class="btn btn-sm btn-outline-secondary ms-1" onclick="editProduct('${p.id}')">Editar</button>
          <button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteProduct('${p.id}')">Apagar</button>` : ''}
        </td>`
      tbody.appendChild(tr)
    })
  }

  // Editar (l√≥gica local, mantida)
  window.editProduct = function(id) { // Exposto globalmente
    if(currentUser.role !== 'admin') return
    const p = products.find(x=>x.id===id); if(!p) return
    document.getElementById('produtoId').value = p.id
    document.getElementById('produtoNome').value = p.name
    document.getElementById('produtoCodigo').value = p.code
    document.getElementById('produtoQtd').value = p.qty
    document.getElementById('produtoMin').value = p.minQty||0
    document.getElementById('produtoCusto').value = p.cost
    document.getElementById('produtoPreco').value = p.price
    document.getElementById('produtoExport').checked = !!p.exportFlag
    window.scrollTo({top:0,behavior:'smooth'})
  }

  // Deletar (MODIFICADO)
  window.deleteProduct = async function(id) { // Exposto globalmente
    if(currentUser.role !== 'admin') return
    if(!confirm('Apagar produto?')) return
    
    // Remove do array local
    products = products.filter(p=>p.id!==id)
    
    // SALVA O BD NA API
    await saveDatabase();
    
    renderProducts(); 
    renderProductOptions(); 
    computeReport();
  }

  /* ===========================
     VENDAS (MODIFICADO)
     =========================== */
  
  // Renderizar Op√ß√µes (l√≥gica local, mantida)
  function renderProductOptions(){
    const sel = document.getElementById('saleProduct'); sel.innerHTML=''
    products.forEach(p=>{
      const opt = document.createElement('option'); opt.value=p.id; opt.text = `${p.name} ‚Äî Q:${p.qty}`
      sel.appendChild(opt)
    })
    // preset price if seller selects nothing
    const selVal = document.getElementById('saleProduct').value
    if(selVal){
      const p = products.find(x=>x.id===selVal)
      if(p) document.getElementById('salePrice').value = p.price || 0
    } else if(products.length){
      document.getElementById('saleProduct').value = products[0].id
      document.getElementById('salePrice').value = products[0].price || 0
    } else {
      document.getElementById('salePrice').value = 0
    }
  }

  // Atualizar Pre√ßo (l√≥gica local, mantida)
  document.getElementById('saleProduct').addEventListener('change', ()=>{
    const id = document.getElementById('saleProduct').value
    const p = products.find(x=>x.id===id)
    if(p) document.getElementById('salePrice').value = p.price || 0
  })

  // SUBMIT DO FORMUL√ÅRIO DE VENDA (MODIFICADO)
  document.getElementById('formVenda').addEventListener('submit', async e => {
    e.preventDefault()
    const productId = document.getElementById('saleProduct').value
    const qty = Number(document.getElementById('saleQty').value||0)
    const price = Number(document.getElementById('salePrice').value||0)
    const seller = currentUser.username
    const pct = Number(document.getElementById('saleCommissionPct').value||0)
    
    if(!productId || qty<=0) return alert('Selecione produto e quantidade v√°lida')
    
    const p = products.find(x=>x.id===productId)
    if(!p) return alert('Produto n√£o encontrado')
    if(qty > p.qty) return alert('Quantidade maior que estoque')
    
    const total = qty * price
    const commission = total * (pct/100)
    const date = todayISO()
    
    // Adiciona √† lista de vendas local
    const sale = { id: uid(), date, productId, productName: p.name, qty, unit: price, total, seller, commission, cost: (p.cost||0)*qty, commissionPct: pct }
    sales.push(sale)
    
    // Atualiza o produto local
    p.qty = p.qty - qty
    
    // SALVA TUDO NA API (vendas e produtos atualizados)
    await saveDatabase();
    
    renderProducts(); 
    renderProductOptions(); 
    renderSales(); 
    computeReport();
    
    document.getElementById('saleQty').value = 1
    alert('Venda registrada: R$ ' + money(total))
  })

  // Renderizar/Filtrar Vendas (l√≥gica local, mantida)
  // Essas fun√ß√µes leem da vari√°vel global 'sales'
  function renderSales(list = sales.slice()){
    const tbody = document.getElementById('salesTbody'); tbody.innerHTML = ''
    const showList = currentUser.role==='vendedor' ? (list.filter(s=>s.seller===currentUser.username)) : list
    showList.slice().reverse().forEach(s=>{
      const tr = document.createElement('tr')
      tr.innerHTML = `<td>${s.date}</td><td>${s.productName}</td><td>${s.qty}</td><td>R$ ${money(s.unit)}</td><td>R$ ${money(s.total)}</td><td>${s.seller}</td><td>R$ ${money(s.commission)}</td>`
      tbody.appendChild(tr)
    })
  }
  window.filterSales = function() { // Exposto globalmente
    const start = document.getElementById('saleFilterStart').value
    const end = document.getElementById('saleFilterEnd').value
    const seller = (document.getElementById('saleFilterSeller').value||'').toLowerCase().trim()
    let filtered = sales.slice()
    if(start) filtered = filtered.filter(s=> s.date >= start)
    if(end) filtered = filtered.filter(s=> s.date <= end)
    if(seller) filtered = filtered.filter(s=> (s.seller||'').toLowerCase().includes(seller))
    if(currentUser.role === 'vendedor') filtered = filtered.filter(s=> s.seller === currentUser.username)
    renderSales(filtered)
  }
  window.showAllSales = function() { renderSales(sales) } // Exposto globalmente

  /* ===========================
     DESPESAS (MODIFICADO)
     =========================== */
  document.getElementById('formDespesa').addEventListener('submit', async e => {
    e.preventDefault()
    if(currentUser.role !== 'admin') return alert('Apenas admin pode registrar despesas')
    
    const desc = document.getElementById('expenseDesc').value.trim()
    const value = Number(document.getElementById('expenseValue').value||0)
    const date = document.getElementById('expenseDate').value || todayISO()
    
    if(!desc || value<=0) return alert('Descri√ß√£o e valor obrigat√≥rios')
    
    // Adiciona √† lista local
    const ex = { id: uid(), date, desc, value }
    expenses.push(ex)
    
    // SALVA O BD NA API
    await saveDatabase();
    
    renderExpenses(); 
    computeReport();
    document.getElementById('expenseDesc').value=''; document.getElementById('expenseValue').value=''
  })

  // Renderizar/Filtrar Despesas (l√≥gica local, mantida)
  // Leem da vari√°vel global 'expenses'
  function renderExpenses(list = expenses.slice()){
    const tbody = document.getElementById('expensesTbody'); tbody.innerHTML = ''
    list.slice().reverse().forEach(e=>{
      const tr = document.createElement('tr')
      tr.innerHTML = `<td>${e.date}</td><td>${e.desc}</td><td>R$ ${money(e.value)}</td>`
      tbody.appendChild(tr)
    })
  }
  window.filterExpenses = function() { // Exposto globalmente
    const start = document.getElementById('expenseFilterStart').value
    const end = document.getElementById('expenseFilterEnd').value
    let filtered = expenses.slice()
    if(start) filtered = filtered.filter(d=> d.date >= start)
    if(end) filtered = filtered.filter(d=> d.date <= end)
    renderExpenses(filtered)
  }
  window.showAllExpenses = function() { renderExpenses(expenses) } // Exposto globalmente

  /* ===========================
     USU√ÅRIOS (DESATIVADO)
     =========================== */
  // Sua API n√£o tem rotas para /api/users (GET, POST, DELETE)
  // Por isso, toda a l√≥gica de gerenciamento de usu√°rios foi desativada.
  // O login (acima) √© a √∫nica intera√ß√£o com usu√°rios.
  
  /*
  async function renderUsers(){ ... }
  document.getElementById('formUser').addEventListener('submit', ... )
  async function promptChangePass(username){ ... }
  function removeUser(username){ ... }
  */

  /* ===========================
     RELAT√ìRIOS (L√≥gica local mantida)
     =========================== */
  // Esta fun√ß√£o agora usa os arrays globais
  function computeReport(){
    const stock = products.reduce((sum,p) => sum + ((p.cost||0) * (p.qty||0)), 0)
    const salesTotal = sales.reduce((sum,s) => sum + (s.total||0), 0)
    const expensesTotal = expenses.reduce((sum,e) => sum + (e.value||0), 0)
    const commTotal = sales.reduce((sum,s) => sum + (s.commission||0), 0)
    // Lucro = Vendas - Custo dos Produtos Vendidos - Despesas - Comiss√µes
    const salesCost = sales.reduce((sum,s) => sum + (s.cost||0), 0)
    const net = salesTotal - salesCost - expensesTotal - commTotal

    document.getElementById('reportStock').innerText = money(stock)
    document.getElementById('reportSales').innerText = money(salesTotal)
    document.getElementById('reportExpenses').innerText = money(expensesTotal)
    document.getElementById('reportCommissions').innerText = money(commTotal)
    document.getElementById('reportNet').innerText = money(net)
  }

  /* ===========================
     EXPORT / IMPORT (MODIFICADO)
     =========================== */
  
  // Exportar CSV (l√≥gica local mantida)
  window.escapeCsv = function(s){ if(s==null) return '""'; return '"' + String(s).replace(/"/g,'""') + '"' }
  window.exportCSV = function(type){
    if(type==='products'){
      const rows = products.filter(p=>p.exportFlag)
      if(rows.length===0) return alert('Nenhum produto marcado para exportar.')
      let csv = 'name,code,price\n'
      rows.forEach(p=> csv += `${escapeCsv(p.name)},${escapeCsv(p.code)},${p.price}\n`)
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `produtos_exportados.csv`; a.click(); URL.revokeObjectURL(a.href)
    } else if(type==='sales'){
      let rows = sales.slice()
      if(currentUser.role==='vendedor') rows = rows.filter(s=> s.seller === currentUser.username)
      if(rows.length===0) return alert('Nenhuma venda para exportar.')
      let csv = 'date,productName,qty,unit,total,seller,commission\n'
      rows.forEach(s=> csv += `${s.date},${escapeCsv(s.productName)},${s.qty},${s.unit},${s.total},${escapeCsv(s.seller)},${s.commission}\n`)
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `vendas_${currentUser.username}.csv`; a.click(); URL.revokeObjectURL(a.href)
    } else if(type==='expenses'){
      if(currentUser.role!=='admin') return alert('Apenas admin pode exportar despesas')
      if(expenses.length===0) return alert('Nenhuma despesa registrada')
      let csv = 'date,desc,value\n'
      expenses.forEach(e=> csv += `${e.date},${escapeCsv(e.desc)},${e.value}\n`)
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `despesas.csv`; a.click(); URL.revokeObjectURL(a.href)
    }
  }

  // Fun√ß√µes de Backup/Import JSON (REMOVIDAS)
  // Isso agora √© feito automaticamente pelo servidor.
  // window.exportBackup = function(){ ... }
  // window.importBackup = function(event){ ... }

  </script>
  </body>
</html>
