<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Sistema Semi J√≥ias ‚Äî com Backup √önico</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>

  <style>
    body{background:#f5f7fb;font-family:Inter,Arial,Helvetica,sans-serif}
    .container{max-width:1100px;margin-top:24px}
    .card{border-radius:10px}
    .small-input{height:38px;padding:6px}
    .muted{color:#6b7280}
    .table-fixed tbody{height:220px;overflow:auto;display:block}
    .table-fixed thead, .table-fixed tbody tr{display:table;width:100%;table-layout:fixed}
    .table-fixed thead{width:100%}
    .badge-low{background:#fff3cd;color:#a35b00;padding:4px 8px;border-radius:8px}
    .badge-empty{background:#f8d7da;color:#842029;padding:4px 8px;border-radius:8px}
  </style>
</head>
<body>
  <div class="container">
    <h2 class="mb-3 text-center">üíé Sistema de Estoque ‚Äî Semi J√≥ias</h2>

    <!-- Nav -->
    <ul class="nav nav-tabs mb-3" id="mainTabs" role="tablist">
      <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#estoqueTab">Estoque</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#vendasTab">Vendas</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#despesasTab">Despesas</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#relTab">Relat√≥rios</button></li>
    </ul>

    <div class="tab-content">

      <!-- ESTOQUE -->
      <div class="tab-pane fade show active" id="estoqueTab">
        <div class="card mb-3">
          <div class="card-body">
            <h5>Cadastrar / Editar Produto</h5>
            <form id="formProduto" class="row g-2 align-items-end">
              <input type="hidden" id="produtoId"/>
              <div class="col-md-5">
                <label class="form-label small">Nome</label>
                <input id="produtoNome" class="form-control" required/>
              </div>
              <div class="col-md-2">
                <label class="form-label small">C√≥digo</label>
                <input id="produtoCodigo" class="form-control"/>
              </div>
              <div class="col-md-2">
                <label class="form-label small">Quantidade</label>
                <input id="produtoQtd" type="number" min="0" class="form-control small-input" value="1"/>
              </div>
              <div class="col-md-1">
                <label class="form-label small">Min</label>
                <input id="produtoMin" type="number" min="0" class="form-control small-input" value="0"/>
              </div>
              <div class="col-md-1">
                <label class="form-label small">Custo</label>
                <input id="produtoCusto" type="number" step="0.01" class="form-control small-input" value="0"/>
              </div>
              <div class="col-md-1">
                <label class="form-label small">Pre√ßo</label>
                <input id="produtoPreco" type="number" step="0.01" class="form-control small-input" value="0"/>
              </div>

              <div class="col-12 text-end mt-1">
                <button class="btn btn-success btn-sm" type="submit">Salvar</button>
                <button class="btn btn-outline-secondary btn-sm" type="button" id="limparProdutoBtn">Limpar</button>
                <button class="btn btn-outline-secondary btn-sm" type="button" onclick="exportCSV('products')">Exportar CSV</button>
              </div>
            </form>
          </div>
        </div>

        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div class="d-flex gap-2">
                <input id="searchProduct" class="form-control form-control-sm" placeholder="Buscar por nome ou c√≥digo" style="min-width:280px"/>
                <button class="btn btn-sm btn-outline-secondary" onclick="renderProducts()">Buscar</button>
              </div>
              <div class="muted">Dados salvos no navegador (localStorage)</div>
            </div>

            <div style="overflow:auto;max-height:360px">
              <table class="table table-sm table-striped">
                <thead class="table-light"><tr><th>Nome</th><th>C√≥d</th><th>Qtd</th><th>Min</th><th>Pre√ßo</th><th>Custo</th><th></th></tr></thead>
                <tbody id="productsTbody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- VENDAS -->
      <div class="tab-pane fade" id="vendasTab">
        <div class="card mb-3">
          <div class="card-body">
            <h5>Registrar Venda</h5>
            <form id="formVenda" class="row g-2 align-items-end">
              <div class="col-md-4">
                <label class="form-label small">Produto</label>
                <select id="saleProduct" class="form-select"></select>
              </div>
              <div class="col-md-2">
                <label class="form-label small">Pre√ßo (sugerido ‚Äî edit√°vel)</label>
                <input id="salePrice" type="number" step="0.01" class="form-control small-input"/>
              </div>
              <div class="col-md-1">
                <label class="form-label small">Qtd</label>
                <input id="saleQty" type="number" min="1" class="form-control small-input" value="1"/>
              </div>
              <div class="col-md-2">
                <label class="form-label small">Vendedor</label>
                <input id="saleSeller" class="form-control"/>
              </div>
              <div class="col-md-1">
                <label class="form-label small">Comiss√£o %</label>
                <input id="saleCommissionPct" type="number" step="0.1" class="form-control small-input" value="10"/>
              </div>
              <div class="col-md-2 text-end">
                <button class="btn btn-primary btn-sm" type="submit">Registrar Venda</button>
                <button class="btn btn-outline-secondary btn-sm" type="button" onclick="exportCSV('sales')">Exportar CSV</button>
              </div>
            </form>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-body">
            <h6>Filtros</h6>
            <div class="row g-2 align-items-end">
              <div class="col-md-3"><label class="form-label small">Data in√≠cio</label><input id="saleFilterStart" type="date" class="form-control"/></div>
              <div class="col-md-3"><label class="form-label small">Data fim</label><input id="saleFilterEnd" type="date" class="form-control"/></div>
              <div class="col-md-3"><label class="form-label small">Vendedor</label><input id="saleFilterSeller" class="form-control" placeholder="Deixar em branco para todos"/></div>
              <div class="col-md-3 text-end"><button class="btn btn-secondary btn-sm" onclick="filterSales()">Filtrar</button> <button class="btn btn-outline-secondary btn-sm" onclick="showAllSales()">Mostrar tudo</button></div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-body" style="max-height:320px;overflow:auto">
            <table class="table table-sm table-striped">
              <thead class="table-light"><tr><th>Data</th><th>Produto</th><th>Qtd</th><th>Pre√ßo</th><th>Total</th><th>Vendedor</th><th>Comiss√£o</th></tr></thead>
              <tbody id="salesTbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- DESPESAS -->
      <div class="tab-pane fade" id="despesasTab">
        <div class="card mb-3">
          <div class="card-body">
            <h5>Registrar Despesa</h5>
            <form id="formDespesa" class="row g-2 align-items-end">
              <div class="col-md-6">
                <label class="form-label small">Descri√ß√£o</label>
                <input id="expenseDesc" class="form-control"/>
              </div>
              <div class="col-md-2">
                <label class="form-label small">Valor (R$)</label>
                <input id="expenseValue" type="number" step="0.01" class="form-control small-input"/>
              </div>
              <div class="col-md-2">
                <label class="form-label small">Data</label>
                <input id="expenseDate" type="date" class="form-control"/>
              </div>
              <div class="col-md-2 text-end">
                <button class="btn btn-success btn-sm" type="submit">Adicionar</button>
                <button class="btn btn-outline-secondary btn-sm" type="button" onclick="exportCSV('expenses')">Exportar CSV</button>
              </div>
            </form>
          </div>
        </div>

        <div class="card mb-3">
          <div class="card-body">
            <h6>Filtros de Despesas</h6>
            <div class="row g-2 align-items-end">
              <div class="col-md-4"><label class="form-label small">Data in√≠cio</label><input id="expenseFilterStart" type="date" class="form-control"/></div>
              <div class="col-md-4"><label class="form-label small">Data fim</label><input id="expenseFilterEnd" type="date" class="form-control"/></div>
              <div class="col-md-4 text-end"><button class="btn btn-secondary btn-sm" onclick="filterExpenses()">Filtrar</button> <button class="btn btn-outline-secondary btn-sm" onclick="showAllExpenses()">Mostrar tudo</button></div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-body" style="max-height:320px;overflow:auto">
            <table class="table table-sm table-striped">
              <thead class="table-light"><tr><th>Data</th><th>Descri√ß√£o</th><th>Valor</th></tr></thead>
              <tbody id="expensesTbody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- RELAT√ìRIOS / BACKUP -->
      <div class="tab-pane fade" id="relTab">
        <div class="card mb-3">
          <div class="card-body">
            <h5>Relat√≥rio R√°pido</h5>
            <p><strong>Valor em estoque:</strong> R$ <span id="reportStock">0.00</span></p>
            <p><strong>Vendas (total):</strong> R$ <span id="reportSales">0.00</span></p>
            <p><strong>Despesas (total):</strong> R$ <span id="reportExpenses">0.00</span></p>
            <p><strong>Comiss√µes (total):</strong> R$ <span id="reportCommissions">0.00</span></p>
            <hr/>
            <p><strong>Lucro l√≠quido:</strong> R$ <span id="reportNet">0.00</span></p>
          </div>
        </div>

        <div class="card">
          <div class="card-body">
            <h5>Backup / Restaurar (Arquivo √önico JSON)</h5>
            <div class="row g-2">
              <div class="col-md-4"><button class="btn btn-success" onclick="exportBackup()">Exportar Backup (.json)</button></div>
              <div class="col-md-4"><input type="file" id="importBackupFile" accept=".json" style="display:none" onchange="importBackup(event)"><button class="btn btn-primary" onclick="document.getElementById('importBackupFile').click()">Importar Backup (.json)</button></div>
              <div class="col-md-4"><button class="btn btn-outline-danger" onclick="resetAll()">Apagar tudo (reset)</button></div>
            </div>
            <small class="muted">Exporte antes de atualizar o sistema ‚Äî o arquivo .json cont√©m produtos, vendas e despesas prontos para importar.</small>
          </div>
        </div>
      </div>

    </div> <!-- tab-content -->
  </div> <!-- container -->

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  /* ------------------ KEYS & STATE ------------------ */
  const LS_PRODUCTS = 'sj_products_v2'
  const LS_SALES = 'sj_sales_v2'
  const LS_EXPENSES = 'sj_expenses_v2'

  let products = load(LS_PRODUCTS, [])
  let sales = load(LS_SALES, [])
  let expenses = load(LS_EXPENSES, [])

  /* ------------------ HELPERS ------------------ */
  const money = v => Number(v||0).toLocaleString('pt-BR',{minimumFractionDigits:2,maximumFractionDigits:2})
  const uid = ()=> Date.now().toString(36) + Math.random().toString(36).slice(2,6)
  const todayISO = ()=> new Date().toISOString().split('T')[0]
  function load(key, fallback){ try{ return JSON.parse(localStorage.getItem(key)) || fallback }catch(e){return fallback} }
  function save(key, val){ localStorage.setItem(key, JSON.stringify(val)) }

  /* ------------------ PRODUCTS ------------------ */
  document.getElementById('formProduto').addEventListener('submit', e=>{
    e.preventDefault()
    const id = document.getElementById('produtoId').value
    const name = document.getElementById('produtoNome').value.trim()
    const code = document.getElementById('produtoCodigo').value.trim()
    const qty = Number(document.getElementById('produtoQtd').value || 0)
    const minQty = Number(document.getElementById('produtoMin').value || 0)
    const cost = Number(document.getElementById('produtoCusto').value || 0)
    const price = Number(document.getElementById('produtoPreco').value || 0)
    if(!name) return alert('Nome obrigat√≥rio')
    if(id){
      const p = products.find(x=>x.id===id)
      Object.assign(p, {name,code,qty,minQty,cost,price})
    } else {
      products.push({id: uid(), name, code, qty, minQty, cost, price})
    }
    save(LS_PRODUCTS, products)
    clearProductForm()
    renderProducts()
    renderProductOptions()
    computeReport()
  })

  document.getElementById('limparProdutoBtn').addEventListener('click', clearProductForm)

  function clearProductForm(){
    document.getElementById('produtoId').value = ''
    document.getElementById('produtoNome').value = ''
    document.getElementById('produtoCodigo').value = ''
    document.getElementById('produtoQtd').value = 1
    document.getElementById('produtoMin').value = 0
    document.getElementById('produtoCusto').value = 0
    document.getElementById('produtoPreco').value = 0
  }

  function renderProducts(){
    const tbody = document.getElementById('productsTbody'); tbody.innerHTML = ''
    const q = (document.getElementById('searchProduct').value||'').toLowerCase().trim()
    products.filter(p => (p.name + (p.code||'')).toLowerCase().includes(q)).forEach(p=>{
      const low = Number(p.qty) <= Number(p.minQty||0)
      const tr = document.createElement('tr')
      tr.innerHTML = `<td>${p.name}</td><td>${p.code||''}</td><td>${p.qty}</td><td>${p.minQty||0}</td><td>R$ ${money(p.price)}</td><td>R$ ${money(p.cost)}</td>
        <td class="text-end">
          ${low ? (p.qty==0 ? '<span class="badge-empty">ESGOTADO</span>' : '<span class="badge-low">BAIXO</span>') : ''}
          <button class="btn btn-sm btn-outline-secondary ms-1" onclick="editProduct('${p.id}')">Editar</button>
          <button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteProduct('${p.id}')">Apagar</button>
        </td>`
      tbody.appendChild(tr)
    })
  }

  function editProduct(id){
    const p = products.find(x=>x.id===id); if(!p) return
    document.getElementById('produtoId').value = p.id
    document.getElementById('produtoNome').value = p.name
    document.getElementById('produtoCodigo').value = p.code
    document.getElementById('produtoQtd').value = p.qty
    document.getElementById('produtoMin').value = p.minQty||0
    document.getElementById('produtoCusto').value = p.cost
    document.getElementById('produtoPreco').value = p.price
    window.scrollTo({top:0,behavior:'smooth'})
  }

  function deleteProduct(id){
    if(!confirm('Apagar produto?')) return
    products = products.filter(p=>p.id!==id)
    save(LS_PRODUCTS, products)
    renderProducts(); renderProductOptions(); computeReport()
  }

  /* ------------------ SALES ------------------ */
  function renderProductOptions(){
    const sel = document.getElementById('saleProduct'); sel.innerHTML = ''
    products.forEach(p => {
      const opt = document.createElement('option'); opt.value = p.id; opt.text = `${p.name} ‚Äî Q:${p.qty}`
      sel.appendChild(opt)
    })
    if(products.length) {
      // preset price for first product
      const first = products[0]
      document.getElementById('salePrice').value = first.price || 0
    } else {
      document.getElementById('salePrice').value = 0
    }
  }
  renderProductOptions()

  document.getElementById('saleProduct').addEventListener('change', ()=>{
    const id = document.getElementById('saleProduct').value
    const p = products.find(x=>x.id===id)
    if(p) document.getElementById('salePrice').value = p.price || 0
  })

  document.getElementById('formVenda').addEventListener('submit', e=>{
    e.preventDefault()
    const productId = document.getElementById('saleProduct').value
    const qty = Number(document.getElementById('saleQty').value||0)
    const price = Number(document.getElementById('salePrice').value||0)
    const seller = document.getElementById('saleSeller').value.trim() || '‚Äî'
    const pct = Number(document.getElementById('saleCommissionPct').value||0)

    if(!productId || qty<=0) return alert('Selecione produto e quantidade v√°lida')

    const p = products.find(x=>x.id===productId)
    if(!p) return alert('Produto n√£o encontrado')
    if(qty > p.qty) return alert('Quantidade maior que estoque')

    const total = qty * price
    const commission = total * (pct/100)
    const date = todayISO()
    const sale = { id: uid(), date, productId, productName: p.name, qty, unit: price, total, seller, commission, cost: (p.cost||0)*qty, commissionPct: pct }

    sales.push(sale)
    p.qty = p.qty - qty

    save(LS_SALES, sales)
    save(LS_PRODUCTS, products)

    renderProducts(); renderProductOptions(); renderSales(); computeReport()
    document.getElementById('saleQty').value = 1
    alert('Venda registrada: R$ ' + money(total))
  })

  function renderSales(list = sales.slice()){
    const tbody = document.getElementById('salesTbody'); tbody.innerHTML = ''
    list.slice().reverse().forEach(s=>{
      const tr = document.createElement('tr')
      tr.innerHTML = `<td>${s.date}</td><td>${s.productName}</td><td>${s.qty}</td><td>R$ ${money(s.unit)}</td><td>R$ ${money(s.total)}</td><td>${s.seller}</td><td>R$ ${money(s.commission)}</td>`
      tbody.appendChild(tr)
    })
  }

  function filterSales(){
    const start = document.getElementById('saleFilterStart').value
    const end = document.getElementById('saleFilterEnd').value
    const seller = (document.getElementById('saleFilterSeller').value || '').toLowerCase().trim()
    let filtered = sales.slice()
    if(start) filtered = filtered.filter(s=> s.date >= start)
    if(end) filtered = filtered.filter(s=> s.date <= end)
    if(seller) filtered = filtered.filter(s=> (s.seller||'').toLowerCase().includes(seller))
    renderSales(filtered)
  }
  function showAllSales(){ renderSales(sales) }

  /* ------------------ EXPENSES ------------------ */
  document.getElementById('formDespesa').addEventListener('submit', e=>{
    e.preventDefault()
    const desc = document.getElementById('expenseDesc').value.trim()
    const value = Number(document.getElementById('expenseValue').value||0)
    const date = document.getElementById('expenseDate').value || todayISO()
    if(!desc || value<=0) return alert('Descri√ß√£o e valor obrigat√≥rios')
    const ex = { id: uid(), date, desc, value }
    expenses.push(ex)
    save(LS_EXPENSES, expenses)
    renderExpenses(); computeReport()
    document.getElementById('expenseDesc').value = ''; document.getElementById('expenseValue').value = ''
  })

  function renderExpenses(list = expenses.slice()){
    const tbody = document.getElementById('expensesTbody'); tbody.innerHTML = ''
    list.slice().reverse().forEach(e=>{
      const tr = document.createElement('tr')
      tr.innerHTML = `<td>${e.date}</td><td>${e.desc}</td><td>R$ ${money(e.value)}</td>`
      tbody.appendChild(tr)
    })
  }

  function filterExpenses(){
    const start = document.getElementById('expenseFilterStart').value
    const end = document.getElementById('expenseFilterEnd').value
    let filtered = expenses.slice()
    if(start) filtered = filtered.filter(d=> d.date >= start)
    if(end) filtered = filtered.filter(d=> d.date <= end)
    renderExpenses(filtered)
  }
  function showAllExpenses(){ renderExpenses(expenses) }

  /* ------------------ EXPORT / IMPORT CSV (optional) ------------------ */
  function escapeCsv(s){ return `"${String(s).replace(/"/g,'""')}"` }
  function exportCSV(type){
    let csv = ''
    if(type === 'products'){
      csv += 'id,name,code,qty,min,cost,price\n'
      products.forEach(p=> csv += `${escapeCsv(p.id)},${escapeCsv(p.name)},${escapeCsv(p.code)},${p.qty},${p.minQty||0},${p.cost},${p.price}\n`)
    } else if(type === 'sales'){
      csv += 'id,date,productId,productName,qty,unit,total,seller,commission,commissionPct,cost\n'
      sales.forEach(s=> csv += `${escapeCsv(s.id)},${s.date},${escapeCsv(s.productId)},${escapeCsv(s.productName)},${s.qty},${s.unit},${s.total},${escapeCsv(s.seller)},${s.commission},${s.commissionPct},${s.cost}\n`)
    } else if(type === 'expenses'){
      csv += 'id,date,desc,value\n'
      expenses.forEach(e=> csv += `${escapeCsv(e.id)},${e.date},${escapeCsv(e.desc)},${e.value}\n`)
    }
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `sj_${type}.csv`; a.click(); URL.revokeObjectURL(a.href)
  }

  /* ------------------ BACKUP √öNICO (JSON) ------------------ */
  function exportBackup(){
    const payload = { products, sales, expenses, exportedAt: new Date().toISOString() }
    const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' })
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `sj_backup_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(a.href)
  }

  function importBackup(evt){
    const file = evt.target.files[0]; if(!file) return
    const reader = new FileReader()
    reader.onload = e=>{
      try{
        const data = JSON.parse(e.target.result)
        if(data.products && data.sales && data.expenses){
          products = data.products
          sales = data.sales
          expenses = data.expenses
          save(LS_PRODUCTS, products); save(LS_SALES, sales); save(LS_EXPENSES, expenses)
          renderProducts(); renderProductOptions(); renderSales(); renderExpenses(); computeReport()
          alert('Backup importado com sucesso!')
        } else {
          alert('Arquivo inv√°lido: n√£o cont√©m products/sales/expenses')
        }
      }catch(err){ alert('Erro ao ler arquivo: ' + err.message) }
    }
    reader.readAsText(file)
    // reset input
    evt.target.value = ''
  }

  /* ------------------ RESET ------------------ */
  function resetAll(){
    if(!confirm('Apagar TODOS os dados locais?')) return
    localStorage.removeItem(LS_PRODUCTS); localStorage.removeItem(LS_SALES); localStorage.removeItem(LS_EXPENSES)
    products=[]; sales=[]; expenses=[]
    renderProducts(); renderProductOptions(); renderSales(); renderExpenses(); computeReport()
  }

  /* ------------------ REPORTS ------------------ */
  function computeReport(){
    const stockVal = products.reduce((s,p)=> s + (Number(p.qty||0) * Number(p.cost||0)), 0)
    const totalSales = sales.reduce((s,x)=> s + Number(x.total||0), 0)
    const totalExpenses = expenses.reduce((s,x)=> s + Number(x.value||0), 0)
    const totalCommissions = sales.reduce((s,x)=> s + Number(x.commission||0), 0)
    const costSold = sales.reduce((s,x)=> s + Number(x.cost||0), 0)
    const grossProfit = totalSales - costSold
    const netProfit = grossProfit - totalExpenses - totalCommissions

    document.getElementById('reportStock').innerText = money(stockVal)
    document.getElementById('reportSales').innerText = money(totalSales)
    document.getElementById('reportExpenses').innerText = money(totalExpenses)
    document.getElementById('reportCommissions').innerText = money(totalCommissions)
    document.getElementById('reportNet').innerText = money(netProfit)
  }

  /* ------------------ BOOTSTRAP / INIT ------------------ */
  // initial render
  renderProducts(); renderProductOptions(); renderSales(); renderExpenses(); computeReport()

  // attach import backup handler
  document.getElementById('importBackupFile').addEventListener('change', importBackup)
  </script>
</body>
</html>
